# 视频合成功能指南

## 📊 功能1: 进度预览接口

### 功能简介
在生成视频前，用户可以查看系统将生成多少个视频以及预计需要的资源。

### 技术实现

**API 端点：**
```
GET /project/{project_id}/video-preview
```

**返回数据示例：**
```json
{
  "success": true,
  "data": {
    "total_queue_count": 161,          // 预计生成的视频数量
    "total_duration": 571276.64,        // 所有音频的总时长（秒）
    "segment_duration": 3600,           // 单个视频目标时长
    "completed_segments": 2259,         // 已完成的音频段数
    "estimated_time_minutes": 9521,     // 预计总耗时（分钟）
    "estimated_disk_space_mb": 857000,  // 预计磁盘占用（MB）
    "preview_available": true           // 预览是否可用
  }
}
```

**功能特点：**
- ✅ 支持两种模式：
  - **预生成模式**：当队列尚未生成时，根据已完成音频计算预览
  - **实时模式**：当队列已生成时，直接返回实际的队列信息
- ✅ 自动计算预计视频数量、磁盘空间、耗时等关键指标
- ✅ 帮助用户优化项目配置和资源规划

### 使用场景

1. **用户在点击"生成视频"前查看预览**
   - 了解将生成多少个视频
   - 评估所需的磁盘空间
   - 判断合成时间

2. **已生成队列后查看实际信息**
   - 显示队列详情而非预估值

---

## 📋 功能2: 队列管理Web UI

### 功能简介
提供一个可视化界面来管理和监控视频合成队列的生成和处理进度。

### 访问路径
```
/project/{project_id}/queue-management
```

### UI 组件

#### 1. 生成预览卡片
显示以下信息：
- 预计视频数
- 总时长（分钟）
- 磁盘空间（MB）
- 单段时长（秒）

```
┌─────────────────────────────────────────┐
│              生成预览                     │
├──────┬──────┬──────┬──────┐
│ 161个│9521分│857GB │3600秒│
│ 视频 │  钟  │  空间 │ 时长 │
└──────┴──────┴──────┴──────┘
```

#### 2. 队列统计卡片
实时显示队列处理状态：
- 总队列数：161
- 已完成：X
- 处理中：X
- 待处理：X

```
┌─────┬─────┬─────┬─────┐
│ 161 │  0  │  0  │ 161 │
│总队列│已完成│处理中│待处理│
└─────┴─────┴─────┴─────┘
```

#### 3. 整体进度条
显示队列完成进度（0-100%）

#### 4. 队列详情表格
| 序号 | 状态 | 时长 | 音频数 | 合成进度 | 输出文件 |
|------|------|------|--------|---------|---------|
| 001  | 已完成 | 3600s | 14 | 100% | 正版修仙_001.mp4 |
| 002  | 处理中 | 3516s | 14 | 78% | 正版修仙_002.mp4 |
| 003  | 待处理 | 3488s | 14 | 0% | 正版修仙_003.mp4 |

#### 5. 操作面板
- **🔄 刷新队列**：立即刷新队列信息
- **⏱️ 自动刷新**：启用/禁用自动刷新（3秒一次）

### API 端点

**获取队列列表：**
```
GET /project/{project_id}/queue-list
```

**返回数据示例：**
```json
{
  "success": true,
  "data": {
    "total_queues": 161,
    "completed_queues": 10,
    "running_queues": 2,
    "pending_queues": 149,
    "progress_percentage": 6,
    "queues": [
      {
        "id": 1,
        "video_index": 1,
        "status": "completed",
        "total_duration": 3569.5,
        "segment_count": 14,
        "synthesized_count": 14,
        "merged_count": 14,
        "output_path": "正版修仙_001.mp4"
      },
      ...
    ]
  }
}
```

### 队列状态说明

| 状态 | 含义 | 颜色 |
|------|------|------|
| **pending** | 待处理 | 🟡 黄色 |
| **synthesizing** | 处理中 | 🔵 蓝色 |
| **completed** | 已完成 | 🟢 绿色 |

### 功能特点

✅ **实时监控**
- 自动刷新队列状态
- 动态显示合成进度
- 支持手动刷新

✅ **详细信息**
- 每个队列的时长和音频数
- 合成进度条（已合成/总数）
- 输出文件路径

✅ **用户友好**
- 直观的进度条和统计卡片
- 色彩编码的状态指示
- 响应式设计（支持移动端）

✅ **自动化**
- 可启用自动刷新（3秒一次）
- 自动计算进度百分比
- 实时更新统计数据

---

## 📖 使用流程

### 第1步：创建项目
```
→ 创建项目 → 导入文本 → 配置参数
```

### 第2步：生成音频
```
→ 开始处理 → 语音合成 → 合成完毕
```

### 第3步：预览视频
```
→ 查看预览（自动生成队列）
   ↓
   显示预计视频数、时长、磁盘空间等
```

### 第4步：开始合成
```
→ 点击"生成视频" → 提交合成任务
```

### 第5步：监控进度
```
→ 打开队列管理页面 → 实时监控合成进度
   ↓
   启用自动刷新 → 定期更新状态
```

---

## 🔗 相关代码

### 路由（app/routes/project_routes.py）
```python
@project_bp.route('/<int:project_id>/video-preview', methods=['GET'])
def video_preview(project_id)                    # 进度预览接口

@project_bp.route('/<int:project_id>/queue-list', methods=['GET'])
def queue_list(project_id)                       # 队列列表接口

@project_bp.route('/<int:project_id>/queue-management')
def queue_management(project_id)                 # 队列管理页面
```

### 模板（app/templates/）
```
video_queue_management.html                     # 队列管理页面
project_detail.html                             # 添加了队列管理链接
```

### 数据模型（app/models/）
```
VideoSynthesisQueue.py                          # 队列数据模型
TempVideoSegment.py                             # 临时视频片段模型
```

---

## 📊 性能指标

### 数据量示例
- **项目1**：2259个音频段 → 161个队列
- 平均每个队列：14个音频段
- 总时长：571,276秒 ≈ 158.7小时
- 预计磁盘空间：≈857GB

### 合成时间估算
- 使用FFmpeg -c copy：10-30秒/队列
- 161个队列 → 约26-80分钟（无并行）
- 关键：选择合适的segment_duration减少队列数

---

## 🎯 最佳实践

### 1. 配置优化
```json
{
  "segment_duration": 3600,  // 1小时一个视频
  "format": "mp4",
  "fps": 24,
  "bitrate": "1000k"
}
```

### 2. 监控策略
- 启用自动刷新观察进度
- 定期检查失败队列
- 及时清理临时文件

### 3. 资源规划
- 根据预览评估磁盘空间
- 预估合成耗时安排时间
- 考虑系统负载合理并行

---

## ❓ FAQ

**Q: 为什么队列数量这么多？**
A: 因为项目有2259个音频段，按3600秒分组，所以生成了161个队列。可以通过增加segment_duration来减少队列数。

**Q: 合成需要多长时间？**
A: 根据预览显示的估计时间。实际时间取决于系统性能和配置。使用FFmpeg -c copy会大幅加快速度。

**Q: 可以暂停/取消队列吗？**
A: 当前版本尚未实现队列的暂停/取消功能，可作为后续优化方向。

**Q: 自动刷新会影响性能吗？**
A: 否。自动刷新每3秒调用一次API，只查询数据库，不执行合成，影响极小。

---

## 📝 更新日志

### v1.0 (2025-12-09)
- ✅ 实现进度预览接口 (`/video-preview`)
- ✅ 开发队列管理Web UI (`/queue-management`)
- ✅ 支持自动刷新功能
- ✅ 显示详细队列信息和进度条
- ✅ 响应式UI设计

---

## 🔮 后续优化方向

1. **队列操作**
   - [ ] 支持单个队列重试
   - [ ] 支持批量操作
   - [ ] 支持队列暂停/恢复

2. **监控增强**
   - [ ] 实时日志显示
   - [ ] 错误详情展示
   - [ ] 性能统计分析

3. **用户体验**
   - [ ] 通知提醒（完成/失败）
   - [ ] 下载进度报告
   - [ ] 导出合成统计

---

**开发者**: AI Assistant
**版本**: 1.0
**最后更新**: 2025-12-09
