{% extends "base.html" %}

{% block title %}è§†é¢‘åˆæˆé˜Ÿåˆ— - {{ project.name }}{% endblock %}

{% block content %}
<div class="video-queue-page">
    <div class="page-header">
        <h2>è§†é¢‘åˆæˆé˜Ÿåˆ— - {{ project.name }}</h2>
        <div>
            <a href="{{ url_for('project.detail', project_id=project.id) }}" class="btn btn-secondary">è¿”å›é¡¹ç›®</a>
        </div>
    </div>
    
    {% if queues %}
    <!-- ç”Ÿæˆé¢„è§ˆå¡ç‰‡ -->
    <div class="info-card">
        <h3>ğŸ“Š ç”Ÿæˆé¢„è§ˆ</h3>
        <div id="previewLoading" class="loading" style="text-align: center;">
            <p>åŠ è½½é¢„è§ˆä¿¡æ¯ä¸­...</p>
        </div>
        <div id="previewContent" style="display: none;">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æŒ‡æ ‡</th>
                            <th>æ•°å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="preview-label-cell">é¢„è®¡è§†é¢‘æ•°</td>
                            <td class="preview-value-cell"><span id="previewQueueCount">-</span> ä¸ª</td>
                        </tr>
                        <tr>
                            <td class="preview-label-cell">æ€»æ—¶é•¿</td>
                            <td class="preview-value-cell"><span id="previewTotalDuration">-</span> åˆ†é’Ÿ</td>
                        </tr>
                        <tr>
                            <td class="preview-label-cell">é¢„è®¡ç£ç›˜ç©ºé—´</td>
                            <td class="preview-value-cell"><span id="previewDiskSpace">-</span> MB</td>
                        </tr>
                        <tr>
                            <td class="preview-label-cell">å•æ®µæ—¶é•¿</td>
                            <td class="preview-value-cell"><span id="previewSegmentDuration">-</span> ç§’</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info" id="previewMessage" style="margin-top: 12px; display: none;"></div>
        </div>
    </div>
    
    <!-- é˜Ÿåˆ—ç»Ÿè®¡å¡ç‰‡ -->
    <div class="info-card">
        <h3>ğŸ“ˆ é˜Ÿåˆ—ç»Ÿè®¡</h3>
        <div class="queue-stats" style="margin-bottom: 20px;">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ total_queues }}</div>
                    <div class="stat-label">æ€»é˜Ÿåˆ—æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ completed_count }}</div>
                    <div class="stat-label">å·²å®Œæˆé˜Ÿåˆ—</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ pending_count }}</div>
                    <div class="stat-label">å¾…å¤„ç†é˜Ÿåˆ—</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ synthesizing_count }}</div>
                    <div class="stat-label">åˆæˆä¸­é˜Ÿåˆ—</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ (completed_count / total_queues * 100) | round(1) }} %</div>
                    <div class="stat-label">å®Œæˆè¿›åº¦</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ total_duration | round(0) | int }} ç§’</div>
                    <div class="stat-label">æ€»è§†é¢‘æ—¶é•¿</div>
                </div>
            </div>
            
            {% if total_queues > 0 %}
            <div class="progress-bar" style="margin-top: 20px;">
                <div class="progress-fill" style="width: 0%" data-width="{{ (completed_count / total_queues * 100) | int }}"></div>
            </div>
            <p class="progress-text">é˜Ÿåˆ—å®Œæˆè¿›åº¦: {{ (completed_count / total_queues * 100) | int }}%</p>
            {% endif %}
        </div>
    </div>
    
    <!-- é˜Ÿåˆ—é¢„è§ˆå¡ç‰‡ -->
    <div class="info-card">
        <h3>ğŸ“‹ é˜Ÿåˆ—é¢„è§ˆ</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>é˜Ÿåˆ—ID</th>
                        <th>è§†é¢‘åºå·</th>
                        <th>çŠ¶æ€</th>
                        <th>æ€»æ—¶é•¿</th>
                        <th>ç‰‡æ®µè¿›åº¦</th>
                        <th>è¾“å‡ºæ–‡ä»¶</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ›´æ–°æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in queues %}
                    <tr>
                        <td>{{ item.queue.id }}</td>
                        <td>{{ item.queue.video_index }}</td>
                        <td>
                            <span class="badge badge-{{ item.queue.status }}">
                                {% if item.queue.status == 'pending' %}å¾…å¤„ç†
                                {% elif item.queue.status == 'synthesizing' %}åˆæˆä¸­
                                {% elif item.queue.status == 'completed' %}å·²å®Œæˆ
                                {% else %}{{ item.queue.status }}
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ item.queue.total_duration | round(2) }} ç§’</td>
                        <td>{{ item.completed_segments }}/{{ item.total_segments }}</td>
                        <td><code>{{ item.queue.output_video_path }}</code></td>
                        <td>{{ item.queue.created_at }}</td>
                        <td>{{ item.queue.updated_at or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ“ä½œé¢æ¿ -->
    <div class="info-card">
        <h3>âš™ï¸ æ“ä½œ</h3>
        <div class="action-buttons">
            <button id="btnRefreshQueue" class="btn btn-primary">ğŸ”„ åˆ·æ–°é˜Ÿåˆ—</button>
            <button id="btnAutoRefresh" class="btn btn-secondary">â±ï¸ è‡ªåŠ¨åˆ·æ–° (å…³)</button>
        </div>
        <p class="hint" style="margin-top: 8px;">
            æç¤ºï¼šæ¯ä¸ªé˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚åˆæˆçŠ¶æ€ä» <code>pending</code> â†’ <code>synthesizing</code> â†’ <code>completed</code>
        </p>
    </div>
    {% else %}
    <div class="info-card">
        <p>æš‚æ— è§†é¢‘åˆæˆé˜Ÿåˆ—æ•°æ®ã€‚è¯·å…ˆç‚¹å‡»"ç”Ÿæˆè§†é¢‘"æŒ‰é’®åˆ›å»ºé˜Ÿåˆ—ã€‚</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
/* é¢„è¾£è¡¨æ ¼æ ·å¼ */
.preview-label-cell {
    font-weight: 600;
    color: #333;
    background: #f9f9f9;
    width: 40%;
}

.preview-value-cell {
    font-weight: 500;
    color: #007bff;
    font-size: 16px;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.action-buttons .btn {
    padding: 8px 16px;
    font-size: 14px;
}

.hint {
    font-size: 12px;
    color: #666;
    background: #f9f9f9;
    padding: 8px 12px;
    border-left: 3px solid #667eea;
}

.alert {
    padding: 12px;
    border-radius: 4px;
    margin: 12px 0;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.loading {
    padding: 20px;
    text-align: center;
    color: #666;
}

@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval = null;
let autoRefreshEnabled = false;

document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®è¿›åº¦æ¡å®½åº¦
    var fills = document.querySelectorAll('.progress-fill');
    fills.forEach(function(fill) {
        if (fill && fill.dataset && fill.dataset.width) {
            var w = parseInt(fill.dataset.width, 10);
            if (!isNaN(w) && w >= 0 && w <= 100) {
                fill.style.width = w + '%';
            }
        }
    });
    
    // åŠ è½½é¢„è§ˆä¿¡æ¯
    loadVideoPreview();
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('btnRefreshQueue').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = 'åŠ è½½ä¸­...';
        location.reload();
    });
    
    document.getElementById('btnAutoRefresh').addEventListener('click', function() {
        toggleAutoRefresh();
    });
});

// åŠ è½½è§†é¢‘é¢„è§ˆä¿¡æ¯
async function loadVideoPreview() {
    const projectId = '{{ project.id }}';
    const previewLoading = document.getElementById('previewLoading');
    const previewContent = document.getElementById('previewContent');
    
    try {
        // å°è¯•è°ƒç”¨è§†é¢‘é¢„è§ˆAPI
        const response = await fetch(`/project/${projectId}/video-preview`);
        const data = await response.json();
        
        previewLoading.style.display = 'none';
        previewContent.style.display = 'block';
        
        if (data.success) {
            const preview = data.data;
            document.getElementById('previewQueueCount').textContent = preview.total_queue_count;
            document.getElementById('previewTotalDuration').textContent = preview.estimated_time_minutes;
            document.getElementById('previewDiskSpace').textContent = preview.estimated_disk_space_mb || '-';
            document.getElementById('previewSegmentDuration').textContent = preview.segment_duration;
            
            if (preview.message) {
                const msg = document.getElementById('previewMessage');
                msg.textContent = preview.message;
                msg.style.display = 'block';
            }
        }
    } catch (e) {
        previewLoading.textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
    }
}

// åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
function toggleAutoRefresh() {
    const btn = document.getElementById('btnAutoRefresh');
    
    if (autoRefreshEnabled) {
        // å…³é—­è‡ªåŠ¨åˆ·æ–°
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–° (å…³)';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    } else {
        // å¯ç”¨è‡ªåŠ¨åˆ·æ–°
        autoRefreshEnabled = true;
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–° (å¼€)';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        
        // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°
        autoRefreshInterval = setInterval(() => {
            location.reload();
        }, 3000);
    }
}
</script>
{% endblock %}
